<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Générateur Quittance | Nathan Marzilli</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        dark: { 950: '#020617', 900: '#0B1120', 800: '#1E293B' },
                        accent: { 400: '#2DD4BF', 500: '#14B8A6' }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- UI APPLICATION --- */
        body { background-color: #020617; color: #E2E8F0; }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border-radius: 1.5rem;
        }

        .input-premium {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        .input-premium:focus {
            border-color: #2DD4BF;
            outline: none;
            box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.1);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .label-premium {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #94A3B8;
            margin-bottom: 0.35rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Styles des boutons d'adresse rapide */
        .addr-btn {
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .addr-btn:hover {
            background: #2DD4BF;
            color: #020617;
            border-color: #2DD4BF;
            font-weight: 600;
        }
        .addr-btn i { font-size: 1.1em; }

        .section-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-title i { color: #2DD4BF; }

        /* Signature Canvas */
        .sig-wrapper {
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px dashed #475569;
            position: relative;
        }
        canvas.sig-canvas {
            width: 100%;
            height: 120px;
            cursor: crosshair;
            display: block;
            touch-action: none;
        }

        /* --- PDF PREVIEW STYLES (Print Engine) --- */
        #pdf-content {
            background: white;
            color: black;
            font-family: 'Times New Roman', serif;
            font-size: 11pt;
            line-height: 1.4;
            /* LARGEUR CALCULÉE : 
               A4 = 210mm. 
               Marges PDF = 10mm gauche + 10mm droite = 20mm.
               Reste = 190mm.
               Sécurité demandée = -5mm.
               Largeur finale HTML = 185mm.
            */
            width: 185mm; 
            min-height: 100mm; /* Hauteur min pour le rendu */
            padding: 0; /* Pas de padding pour que le titre colle en haut */
            box-sizing: border-box;
            position: relative;
            margin: 0 auto; 
        }

        /* Espacement interne pour le visuel à l'écran, mais compact pour l'impression */
        .pdf-inner-container {
            padding: 5mm 0; 
        }

        .pdf-header-row { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: flex-start; }
        .pdf-landlord { font-weight: bold; font-size: 10pt; line-height: 1.3; }
        .pdf-tenant-box { border: 1px solid #000; padding: 10px 15px; min-width: 240px; border-radius: 4px; max-width: 50%; }
        
        .pdf-title { 
            text-align: center; 
            font-size: 16pt; 
            font-weight: bold; 
            text-transform: uppercase; 
            margin: 10px 0 25px 0; 
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .pdf-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .pdf-table th { border: 1px solid #000; padding: 8px; background: #f3f4f6; text-transform: uppercase; font-size: 10pt; }
        .pdf-table td { border: 1px solid #000; padding: 10px; text-align: center; font-size: 11pt; }
        
        .pdf-legal-text { margin-top: 20px; text-align: justify; }
        .pdf-legal-text strong { text-transform: uppercase; }

        .pdf-nota { 
            margin-top: 30px; 
            font-size: 8pt; 
            color: #444; 
            text-align: justify; 
            border-top: 1px solid #ccc; 
            padding-top: 10px; 
            font-style: italic;
        }

        .pdf-signature { margin-top: 25px; text-align: right; margin-right: 20px; }
        .sig-img { max-height: 80px; margin-top: 5px; }

        /* Responsive Layout */
        .app-grid {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            align-items: start;
        }
        
        /* Mobile / Tablet Styles */
        @media (max-width: 1024px) {
            .app-grid { grid-template-columns: 1fr; }
            /* On cache la preview visuellement sur mobile pour sauver de la place, 
               MAIS elle doit exister pour que le PDF se génère */
            .preview-container { 
                display: none; 
            } 
            /* Classe utilitaire activée temporairement pendant le téléchargement */
            .preview-container.show-for-print { 
                display: block; 
                position: absolute; 
                top: 0; 
                left: 0; 
                z-index: -100;
                opacity: 0;
                pointer-events: none;
            }
            body { padding-bottom: 150px; }
        }

        .sticky-action-bar { margin-top: 2rem; }
        @media (max-width: 1024px) {
            .sticky-action-bar { 
                position: fixed; 
                bottom: 0; 
                left: 0; 
                right: 0; 
                padding: 1rem; 
                background: rgba(2,6,23,0.95); 
                z-index: 50; 
                border-top: 1px solid rgba(255,255,255,0.1); 
                backdrop-filter: blur(10px);
            }
        }
    </style>
</head>
<body class="selection:bg-accent-400/30 selection:text-white pb-24 lg:pb-10">

    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none -z-10">
        <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] mix-blend-screen animate-blob"></div>
        <div class="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-accent-400/10 rounded-full blur-[100px] mix-blend-screen animate-blob animation-delay-2000"></div>
    </div>

    <nav class="w-full border-b border-white/5 bg-dark-950/50 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent-400 to-blue-600 flex items-center justify-center text-dark-950 font-bold">
                    <i class="ph-bold ph-receipt"></i>
                </div>
                <span class="font-display font-bold text-lg tracking-wide text-white">Quittance<span class="text-accent-400">Generator</span></span>
            </div>
            <div class="text-xs font-medium text-slate-400">Marzilli Édition</div>
        </div>
    </nav>

    <main class="app-grid p-4 lg:p-8">
        
        <div class="glass-card form-panel p-6 lg:p-8">
            <div class="mb-6">
                <h1 class="font-display text-2xl font-bold text-white mb-2">Nouvelle Quittance</h1>
                <p class="text-slate-400 text-sm">Génération conforme aux obligations légales (Loi ALUR).</p>
            </div>

            <div class="section-title"><i class="ph-duotone ph-user-circle"></i> 1. Informations Bailleur</div>
            <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                    <label class="label-premium">Propriétaire</label>
                    <input type="text" id="landlordName" value="Nathan MARZILLI" readonly class="input-premium opacity-60 cursor-not-allowed font-bold text-accent-400">
                </div>
                <div>
                    <label class="label-premium">Adresse Fiscale</label>
                    <input type="text" id="landlordAddr" value="75, CHEMIN DES MONTS DU JURA, 74500 CHAMPANGES" readonly class="input-premium opacity-60 cursor-not-allowed">
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-house-line"></i> 2. Location & Locataire</div>
            <div class="space-y-4">
                <div>
                    <label class="label-premium">Nom du Locataire</label>
                    <input type="text" id="tenantName" placeholder="ex: Mme SID Farah" class="input-premium" oninput="updatePreview()">
                </div>
                
                <div>
                    <label class="label-premium">Adresse du bien loué</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3">
                        <button type="button" class="addr-btn" onclick="setAddress('SP1')">
                            <i class="ph-bold ph-map-pin"></i> Saint-Priest 1 (Cerisioz)
                        </button>
                        <button type="button" class="addr-btn" onclick="setAddress('SP2')">
                            <i class="ph-bold ph-map-pin"></i> Saint-Priest 2 (Heyrieux)
                        </button>
                        <button type="button" class="addr-btn" onclick="setAddress('EV1')">
                            <i class="ph-bold ph-house"></i> Evian 1 (Apt 7)
                        </button>
                        <button type="button" class="addr-btn" onclick="setAddress('EV2')">
                            <i class="ph-bold ph-house"></i> Evian 2 (Apt 6)
                        </button>
                        <button type="button" class="addr-btn" onclick="setAddress('EV3')">
                            <i class="ph-bold ph-house"></i> Evian 3 (Touvière)
                        </button>
                    </div>

                    <textarea id="propAddr" rows="3" class="input-premium" oninput="updatePreview()" placeholder="L'adresse s'affichera ici...">41 BIS RUE GARIBALDI
Résidence Les Cerisioz Bâtiment 8D
69800 SAINT-PRIEST</textarea>
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-calendar"></i> 3. Période & Montants</div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="label-premium">Mois Concerné</label>
                    <select id="selMonth" class="input-premium" onchange="calcDates()">
                        <option value="0">Janvier</option>
                        <option value="1">Février</option>
                        <option value="2">Mars</option>
                        <option value="3">Avril</option>
                        <option value="4">Mai</option>
                        <option value="5">Juin</option>
                        <option value="6">Juillet</option>
                        <option value="7">Août</option>
                        <option value="8">Septembre</option>
                        <option value="9">Octobre</option>
                        <option value="10">Novembre</option>
                        <option value="11">Décembre</option>
                    </select>
                </div>
                <div>
                    <label class="label-premium">Année</label>
                    <input type="number" id="selYear" class="input-premium" value="2026" onchange="calcDates()">
                </div>
            </div>
            
            <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4 mb-4">
                <div class="flex justify-between text-sm text-blue-200 mb-2">
                    <span>Période (1er au dernier jour) :</span>
                </div>
                <div class="flex gap-2">
                    <input type="date" id="dateStart" class="input-premium text-sm" onchange="updatePreview()">
                    <input type="date" id="dateEnd" class="input-premium text-sm" onchange="updatePreview()">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="label-premium text-white">Loyer (€)</label>
                    <input type="number" id="rentVal" value="550" step="0.01" class="input-premium font-bold text-lg" oninput="calcTotal()">
                </div>
                <div>
                    <label class="label-premium text-white">Charges (€)</label>
                    <input type="number" id="chargeVal" value="40" step="0.01" class="input-premium font-bold text-lg" oninput="calcTotal()">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="label-premium text-accent-400">Total à payer (€)</label>
                <input type="text" id="totalVal" readonly class="input-premium font-display font-bold text-xl text-accent-400 border-accent-400/30">
            </div>
            
            <div>
                <label class="label-premium">Date de Paiement / Édition</label>
                <input type="date" id="publishDate" class="input-premium" onchange="updatePreview()">
            </div>

            <div class="section-title"><i class="ph-duotone ph-pen-nib"></i> 4. Signature</div>
            <div class="mb-2 flex justify-between items-end">
                <label class="label-premium">Signature Bailleur</label>
                <button onclick="clearPad()" class="text-xs text-red-400 hover:text-red-300 transition-colors">Effacer</button>
            </div>
            <div class="sig-wrapper">
                <canvas id="sigCanvas"></canvas>
            </div>

            <div class="sticky-action-bar">
                <button class="w-full py-4 rounded-xl bg-gradient-to-r from-accent-500 to-blue-600 text-white font-bold text-lg shadow-lg hover:shadow-accent-500/20 hover:scale-[1.01] transition-all flex items-center justify-center gap-3" onclick="generatePDF()">
                    <span>Télécharger la Quittance PDF</span>
                    <i class="ph-bold ph-download-simple"></i>
                </button>
            </div>
        </div>

        <div class="preview-container flex justify-center sticky top-24">
            <div class="relative">
                <div class="absolute inset-0 bg-white transform rotate-1 rounded shadow-xl -z-10 w-[190mm] h-full left-1/2 -translate-x-1/2"></div>
                
                <div id="pdf-content">
                    <div class="pdf-inner-container">
                        <div class="pdf-header-row">
                            <div class="pdf-landlord">
                                <span id="pLandlordName" style="text-transform: uppercase;"></span><br>
                                <span id="pLandlordAddr"></span>
                            </div>
                            <div class="pdf-tenant-box">
                                <strong>Locataire :</strong><br>
                                <span id="pTenantName" style="font-size:12pt; font-weight:bold;"></span><br>
                                Adresse des lieux loués :<br>
                                <span id="pPropAddr" style="white-space: pre-line;"></span>
                            </div>
                        </div>

                        <div class="pdf-title">
                            QUITTANCE DE LOYER<br>
                            <span style="font-size:12pt; font-weight:normal;">DU MOIS DE <span id="pMonthTitle"></span></span>
                        </div>

                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>Loyer</th>
                                    <th>Provisions sur Charges</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span id="pRent"></span> €</td>
                                    <td><span id="pCharges"></span> €</td>
                                    <td style="font-weight:bold;"><span id="pTotal"></span> €</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="pdf-legal-text">
                            Je soussigné, reconnais avoir reçu de <strong><span id="pTenantBody"></span></strong> la somme de : 
                            <strong><span id="pTotalLetters"></span></strong> 
                            pour la période du <strong><span id="pDateStart"></span></strong> au <strong><span id="pDateEnd"></span></strong> 
                            pour le loyer des lieux occupés dans ledit immeuble.
                            <br><br>
                            Dont la quittance sans préjudice du terme courant, sans présomption de paiement des loyers antérieurs, et sous toutes réserves de droit.
                        </div>

                        <div style="margin-top: 20px; font-weight: bold;">
                            PUBLIÉ LE <span id="pDatePublish"></span>
                        </div>

                        <div class="pdf-signature">
                            <div style="margin-bottom:10px; font-weight:bold; text-transform:uppercase;" id="pSignName"></div>
                            <div id="pSigImgContainer"></div>
                        </div>

                        <div class="pdf-nota">
                            <strong>NOTA :</strong> nul locataire ou occupant ne peut déménager avant d'avoir reçu ou donné congé par écrit aux époques prescrites par la loi avant d'avoir fait faire d'abord toutes les réparations locatives qui sont à sa charge et justifié par une quittance du receveur qu'il a acquitté toutes ses contributions de l'année courante. Il doit à son départ libérer complètement les lieux, sous peine de tous frais et dommages-intérêts.
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. GESTION DES ADRESSES ---
        const addresses = {
            'SP1': "41 BIS RUE GARIBALDI\nRésidence Les Cerisioz Bâtiment 8D\n69800 SAINT-PRIEST",
            'SP2': "9 Route d'Heyrieux\n69800 SAINT-PRIEST",
            'EV1': "26 Rue du port\nRésidence TOPOR\n74500 EVIAN-LES-BAINS\nAppartement n°7",
            'EV2': "26 Rue du port\nRésidence TOPOR\n74500 EVIAN-LES-BAINS\nAppartement n°6",
            'EV3': "15 Rue de la Touvière\nRésidence LES RIVES DU LÉMAN\n74500 EVIAN-LES-BAINS"
        };

        function setAddress(key) {
            const addr = addresses[key];
            if(addr) {
                document.getElementById('propAddr').value = addr;
                updatePreview();
                // Petit effet visuel pour confirmer
                const btn = document.activeElement;
                if(btn) {
                    const originalColor = btn.style.borderColor;
                    btn.style.borderColor = "#2DD4BF";
                    setTimeout(() => btn.style.borderColor = originalColor, 300);
                }
            }
        }

        // --- UTILS: Conversion Nombres en Lettres ---
        const writtenNumber = (n) => {
            const map = {
                0: "Zéro", 1: "Un", 2: "Deux", 3: "Trois", 4: "Quatre", 5: "Cinq", 6: "Six", 7: "Sept", 8: "Huit", 9: "Neuf",
                10: "Dix", 11: "Onze", 12: "Douze", 13: "Treize", 14: "Quatorze", 15: "Quinze", 16: "Seize", 20: "Vingt",
                30: "Trente", 40: "Quarante", 50: "Cinquante", 60: "Soixante", 70: "Soixante-dix", 80: "Quatre-vingt", 90: "Quatre-vingt-dix"
            };
            
            let val = parseInt(n);
            let res = "";
            
            if(val >= 100) {
                let h = Math.floor(val/100);
                if(h > 1) res += map[h] + " Cent"; else res += "Cent";
                val %= 100;
                if(val > 0) res += " ";
            }
            
            if(val > 0) {
                if(val < 17) res += map[val];
                else if(val < 20) res += "Dix-" + map[val-10].toLowerCase();
                else {
                    let t = Math.floor(val/10)*10;
                    let u = val % 10;
                    
                    if(t === 70) { t = 60; u += 10; }
                    if(t === 90) { t = 80; u += 10; }

                    res += map[t];
                    if(u > 0) {
                        if(u === 1 && t < 80) res += " et Un";
                        else if(u < 17) res += "-" + map[u]; 
                        else res += "-" + map[u]; 
                    }
                }
            }
            return res.toUpperCase() + " EUROS";
        };


        // --- LOGIC ---
        const getVal = (id) => document.getElementById(id).value;
        const setTxt = (id, txt) => {
            const el = document.getElementById(id);
            if(el) el.innerText = txt;
        };

        // Init Dates
        function init() {
            const d = new Date();
            document.getElementById('selMonth').value = d.getMonth(); // Current Month
            document.getElementById('selYear').value = d.getFullYear();
            document.getElementById('publishDate').valueAsDate = d;
            calcDates();
            
            // Signature Pad
            initPad();
        }

        function calcDates() {
            const m = parseInt(getVal('selMonth'));
            const y = parseInt(getVal('selYear'));
            
            // PÉRIODE : DU 1er AU DERNIER JOUR
            // Date(y, m, 1) -> Le 1er du mois 'm'
            // Date(y, m + 1, 0) -> Le jour 0 du mois suivant, ce qui revient au dernier jour du mois 'm'
            const start = new Date(y, m, 1);
            const end = new Date(y, m + 1, 0);

            document.getElementById('dateStart').valueAsDate = start;
            document.getElementById('dateEnd').valueAsDate = end;
            
            calcTotal();
        }

        function calcTotal() {
            const r = parseFloat(getVal('rentVal')) || 0;
            const c = parseFloat(getVal('chargeVal')) || 0;
            const t = r + c;
            
            document.getElementById('totalVal').value = t.toFixed(2) + " €";
            updatePreview();
        }

        function updatePreview() {
            // Header
            setTxt('pLandlordName', getVal('landlordName'));
            setTxt('pLandlordAddr', getVal('landlordAddr').replace(', ', '\n'));
            
            // Tenant
            setTxt('pTenantName', getVal('tenantName') || "_________________");
            setTxt('pPropAddr', getVal('propAddr'));

            // Title
            const months = ['JANVIER','FÉVRIER','MARS','AVRIL','MAI','JUIN','JUILLET','AOÛT','SEPTEMBRE','OCTOBRE','NOVEMBRE','DÉCEMBRE'];
            const mIndex = parseInt(getVal('selMonth'));
            setTxt('pMonthTitle', months[mIndex] + " " + getVal('selYear'));

            // Table
            setTxt('pRent', parseFloat(getVal('rentVal')).toFixed(2));
            setTxt('pCharges', parseFloat(getVal('chargeVal')).toFixed(2));
            const total = (parseFloat(getVal('rentVal')) + parseFloat(getVal('chargeVal')));
            setTxt('pTotal', total.toFixed(2));

            // Legal Body
            setTxt('pTenantBody', getVal('tenantName') || "Mme/M. [Nom Locataire]");
            setTxt('pTotalLetters', writtenNumber(total));
            
            const formatDate = (dStr) => {
                if(!dStr) return "...";
                const d = new Date(dStr);
                return d.toLocaleDateString('fr-FR');
            };
            
            setTxt('pDateStart', formatDate(getVal('dateStart')));
            setTxt('pDateEnd', formatDate(getVal('dateEnd')));
            setTxt('pDatePublish', formatDate(getVal('publishDate')));
            
            setTxt('pSignName', getVal('landlordName'));
        }

        // --- SIGNATURE PAD ---
        let canvas, ctx, drawing = false;

        function initPad() {
            canvas = document.getElementById('sigCanvas');
            ctx = canvas.getContext('2d');
            
            // Resize logic
            const resize = () => {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = 120;
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#000';
            };
            window.addEventListener('resize', resize);
            resize();

            // Events
            const getPos = (e) => {
                const r = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
                return {x,y};
            }

            const start = (e) => { drawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x, p.y); if(e.type==='touchstart') e.preventDefault(); updateSigPreview(); };
            const move = (e) => { if(!drawing) return; const p=getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); if(e.type==='touchmove') e.preventDefault(); };
            const end = () => { drawing=false; updateSigPreview(); };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start, {passive:false});
            canvas.addEventListener('touchmove', move, {passive:false});
            canvas.addEventListener('touchend', end);
        }

        function clearPad() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('pSigImgContainer').innerHTML = "";
        }

        function updateSigPreview() {
            const img = document.createElement('img');
            img.src = canvas.toDataURL();
            img.className = 'sig-img';
            const cont = document.getElementById('pSigImgContainer');
            cont.innerHTML = '';
            cont.appendChild(img);
        }

        // --- PDF GENERATION FIX ---
        function generatePDF() {
            // CRUCIAL : Scroll en haut pour éviter le bug de page blanche
            window.scrollTo(0, 0);

            const element = document.getElementById('pdf-content');
            const btn = document.querySelector('.sticky-action-bar button');
            const oldTxt = btn.innerHTML;
            
            // Show loader
            btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Génération...`;

            // Mobile formatting fix
            const previewContainer = document.querySelector('.preview-container');
            const wasHidden = window.getComputedStyle(previewContainer).display === 'none';
            
            if(wasHidden) {
                // On rend le container visible mais hors champ pour la capture
                previewContainer.classList.add('show-for-print');
            }

            const monthName = document.getElementById('selMonth').options[document.getElementById('selMonth').selectedIndex].text;
            const year = getVal('selYear');
            // Nettoyage du nom de fichier
            const tenant = (getVal('tenantName') || "Locataire").replace(/[^a-z0-9]/gi, '_').substring(0, 15);

            const opt = {
                margin:       10, // Marges standard A4 (10mm)
                filename:     `Quittance_${monthName}_${year}_${tenant}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Petit délai pour laisser le temps au DOM de s'afficher si caché
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => {
                    btn.innerHTML = oldTxt;
                    if(wasHidden) previewContainer.classList.remove('show-for-print');
                }).catch(err => {
                    console.error(err);
                    alert("Erreur lors de la génération. Veuillez réessayer.");
                    btn.innerHTML = oldTxt;
                    if(wasHidden) previewContainer.classList.remove('show-for-print');
                });
            }, 100);
        }

        // Run
        window.onload = init;
    </script>
</body>
</html>
