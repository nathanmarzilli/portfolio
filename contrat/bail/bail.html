<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Générateur Bail Meublé | Édition Premium</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        dark: { 950: '#020617', 900: '#0B1120', 800: '#1E293B' },
                        accent: { 400: '#2DD4BF', 500: '#14B8A6' }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- UI APPLICATION (MODE SOMBRE) --- */
        body { background-color: #020617; color: #E2E8F0; overflow-x: hidden; }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border-radius: 1.5rem;
        }

        /* Inputs Styling */
        .input-premium {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        .input-premium:focus {
            border-color: #2DD4BF;
            outline: none;
            box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.1);
            background: rgba(15, 23, 42, 0.8);
        }
        
        /* Labels */
        .label-premium {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #94A3B8;
            margin-bottom: 0.35rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Section Titles */
        .section-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-title i { color: #2DD4BF; }

        /* Signatures Canvas */
        .sig-wrapper {
            background: white; /* Toujours blanc pour le contraste de l'encre */
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px dashed #475569;
            position: relative;
        }
        canvas.sig-canvas {
            width: 100%;
            height: 100px;
            cursor: crosshair;
            display: block;
            touch-action: none;
        }

        /* Toggles & Checkboxes */
        .toggle-btn {
            width: 100%;
            text-align: left;
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 0.75rem;
            color: #cbd5e1;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .toggle-btn:hover { background: rgba(255,255,255,0.07); }
        .toggle-btn.active { border-color: #2DD4BF; color: #2DD4BF; background: rgba(45, 212, 191, 0.05); }

        /* Custom Checkbox */
        .chk-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chk-label:hover { background: rgba(255,255,255,0.03); }
        input[type="checkbox"] {
            accent-color: #2DD4BF;
            width: 1.1rem;
            height: 1.1rem;
        }

        /* --- PDF PRINT STYLES (STRICT & ISOLATED) --- */
        #pdf-content {
            background: white;
            color: black;
            font-family: 'Times New Roman', serif;
            font-size: 10pt;
            line-height: 1.25;
            text-align: justify;
            
            /* CORRECTION #1 : Largeur fixée à 208mm (légèrement < 210mm) pour éviter le rognage */
            width: 208mm; 
            max-width: 100%;
            margin: 0 auto;
            padding: 0; 
            
            min-height: 297mm;
            box-sizing: border-box;
            position: relative;
        }

        /* Helper classes internal to PDF */
        .pdf-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .pdf-title { font-size: 15pt; font-weight: bold; text-transform: uppercase; }
        .pdf-subtitle { font-size: 10pt; font-style: italic; margin-top: 5px; }
        .pdf-section-title { font-size: 11pt; font-weight: bold; text-transform: uppercase; background: #eee; padding: 5px; margin-top: 15px; margin-bottom: 8px; border: 1px solid #000; page-break-after: avoid; }
        .pdf-row { display: flex; margin-bottom: 3px; align-items: baseline; }
        .pdf-lbl { font-weight: bold; min-width: 160px; font-size: 10pt; }
        .pdf-val { flex: 1; font-family: Arial, sans-serif; font-size: 9.5pt; font-weight: 500; }
        .pdf-val.blue { color: #1e40af; font-weight: bold; }
        .clause-block { margin-bottom: 10px; page-break-inside: avoid; }
        .clause-title { font-weight: bold; text-decoration: underline; display: block; margin-bottom: 3px; font-size: 10pt; }
        .clause-text { font-size: 9.5pt; text-align: justify; margin-bottom: 4px; }
        .important-box { border: 2px solid #b91c1c; padding: 8px; margin: 10px 0; background: #fff1f2; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-family: Arial, sans-serif; }
        .pdf-table td { border: 1px solid #000; padding: 5px; font-size: 9.5pt; }
        .pdf-table .bg-gray { background: #f3f4f6; font-weight: bold; }
        .signatures-container { margin-top: 20px; border: 1px solid #000; padding: 10px; page-break-inside: avoid; }
        .sig-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .sig-box { border: 1px solid #ccc; height: 100px; padding: 5px; position: relative; }
        .sig-img { display: block; max-height: 65px; max-width: 100%; margin: 5px auto; }
        .sig-name { font-size: 8pt; text-align: center; font-family: Arial; position: absolute; bottom: 2px; width: 95%; left: 2.5%; border-top: 1px dotted #ccc; }
        .avoid-break { page-break-inside: avoid; }

        /* --- RESPONSIVE LAYOUT --- */
        .app-grid {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            align-items: start;
        }

        /* CORRECTION #2 : Responsive Button Logic */
        
        /* Mobile Only (< 768px) : Bouton collé en bas */
        @media (max-width: 767px) {
            .app-grid { grid-template-columns: 1fr; gap: 0; }
            
            .preview-container { 
                position: absolute; 
                opacity: 0; 
                pointer-events: none; 
                height: 0; overflow: hidden;
                z-index: -10;
            }

            .form-panel {
                border-radius: 0;
                border: none;
                background: transparent;
                box-shadow: none;
            }

            .sticky-action-bar {
                position: fixed;
                bottom: 0; left: 0; right: 0;
                padding: 1rem;
                background: rgba(2, 6, 23, 0.9);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(255,255,255,0.1);
                z-index: 50;
                box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            }
        }

        /* Tablet & Desktop (>= 768px) : Bouton statique (ne cache plus rien) */
        @media (min-width: 768px) {
            .sticky-action-bar {
                position: static;
                margin-top: 2rem;
                background: transparent;
                padding: 0;
                border: none;
                box-shadow: none;
            }
        }

        /* Desktop specific layout tweaks still apply via standard CSS above */
        @media (max-width: 1024px) {
             /* Keep layout 1 column for tablet but button is now static thanks to rule above */
             .app-grid { grid-template-columns: 1fr; gap: 0; }
             .preview-container { 
                position: absolute; opacity: 0; pointer-events: none; height: 0; overflow: hidden; z-index: -10;
            }
        }
        
        /* Smooth fade for hidden sections */
        .hidden-section {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body class="selection:bg-accent-400/30 selection:text-white pb-24 lg:pb-10">

    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none -z-10">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] mix-blend-screen animate-blob"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-accent-400/10 rounded-full blur-[100px] mix-blend-screen animate-blob animation-delay-2000"></div>
    </div>

    <nav class="w-full border-b border-white/5 bg-dark-950/50 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent-400 to-blue-600 flex items-center justify-center text-dark-950 font-bold">
                    <i class="ph-bold ph-file-text"></i>
                </div>
                <span class="font-display font-bold text-lg tracking-wide text-white">Bail<span class="text-accent-400">Génération</span></span><span class="font-display font-bold text-lg tracking-wide text-white">Marzilli<span class="text-accent-400">
            </div>
            <div class="text-xs font-medium text-slate-400 hidden sm:block">
                Conforme Loi ALUR 2026
            </div>
        </div>
    </nav>

    <main class="app-grid p-4 lg:p-8">
        
        <div class="glass-card form-panel p-6 lg:p-8">
            <div class="mb-6">
                <h1 class="font-display text-2xl font-bold text-white mb-2">Édition du contrat</h1>
                <p class="text-slate-400 text-sm">Remplissez les informations ci-dessous. Le PDF se mettra à jour automatiquement.</p>
            </div>

            <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4 mb-8 flex gap-3 items-start">
                <i class="ph-fill ph-info text-blue-400 mt-1"></i>
                <div class="text-xs text-blue-200">
                    Les données sont traitées localement dans votre navigateur. Aucune donnée n'est envoyée sur un serveur.
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-user-circle"></i> 1. Propriétaire (Bailleur)</div>
            <div class="space-y-4">
                <div>
                    <label class="label-premium">Nom du Propriétaire</label>
                    <input type="text" id="landlordName" value="Nathan Marzilli" readonly class="input-premium opacity-50 cursor-not-allowed">
                </div>
                <div>
                    <label class="label-premium">Adresse du Propriétaire</label>
                    <input type="text" id="landlordAddress" value="75 CHEMIN DES MONTS DU JURA 74500 CHAMPANGES" readonly class="input-premium opacity-50 cursor-not-allowed">
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-users"></i> 2. Locataire(s)</div>
            <div class="space-y-4">
                <div>
                    <label class="label-premium">Locataire Principal</label>
                    <input type="text" id="t1Name" placeholder="Nom Prénom" class="input-premium">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="label-premium">Né(e) le</label>
                        <input type="date" id="t1Dob" class="input-premium">
                    </div>
                    <div>
                        <label class="label-premium">À (Ville)</label>
                        <input type="text" id="t1Pob" placeholder="Ville Naissance" class="input-premium">
                    </div>
                </div>
                
                <div class="pt-2">
                    <label class="label-premium">Adresse Actuelle</label>
                    <input type="text" id="t1Addr" placeholder="N° et Rue" class="input-premium mb-3">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1">
                            <input type="tel" id="t1CP" placeholder="Code Postal" class="input-premium">
                        </div>
                        <div class="col-span-2">
                            <input type="text" id="t1City" placeholder="Ville" class="input-premium">
                        </div>
                    </div>
                </div>

                <button class="toggle-btn group" onclick="toggle('secT2', this)">
                    <span class="flex items-center gap-2"><i class="ph-bold ph-plus-circle text-accent-400"></i> Ajouter un 2ème Locataire</span>
                    <i class="ph-bold ph-caret-down group-hover:text-accent-400 transition-colors"></i>
                </button>
                
                <div id="secT2" class="hidden-section bg-white/5 rounded-xl p-4 border border-white/5">
                    <label class="label-premium text-accent-400">Locataire 2 (Colocataire / Conjoint)</label>
                    <input type="text" id="t2Name" placeholder="Nom Prénom" class="input-premium mb-3">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input type="date" id="t2Dob" class="input-premium">
                        <input type="text" id="t2Pob" placeholder="Ville Naiss." class="input-premium">
                    </div>
                    <label class="label-premium">Adresse (si différente)</label>
                    <input type="text" id="t2Addr" placeholder="N° et Rue" class="input-premium mb-3">
                    <div class="grid grid-cols-3 gap-3">
                        <input type="tel" id="t2CP" placeholder="CP" class="input-premium col-span-1">
                        <input type="text" id="t2City" placeholder="Ville" class="input-premium col-span-2">
                    </div>
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-shield-check"></i> 3. Caution(s) / Garant(s)</div>
            <div class="space-y-3">
                <button class="toggle-btn group" onclick="toggle('secG1', this)">
                    <span class="flex items-center gap-2"><i class="ph-bold ph-plus-circle text-accent-400"></i> Ajouter un Garant</span>
                    <i class="ph-bold ph-caret-down group-hover:text-accent-400 transition-colors"></i>
                </button>

                <div id="secG1" class="hidden-section bg-white/5 rounded-xl p-4 border border-white/5">
                    <label class="label-premium text-accent-400">Garant 1</label>
                    <input type="text" id="g1Name" placeholder="Nom Prénom" class="input-premium mb-3">
                    <input type="text" id="g1Addr" placeholder="Adresse complète" class="input-premium mb-3">
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <input type="tel" id="g1CP" placeholder="CP" class="input-premium col-span-1">
                        <input type="text" id="g1City" placeholder="Ville" class="input-premium col-span-2">
                    </div>

                    <button class="toggle-btn text-sm py-2" onclick="toggle('secG2', this)">
                        <span>+ Ajouter Garant 2</span>
                        <span>+</span>
                    </button>
                    <div id="secG2" class="hidden-section mt-3 pt-3 border-t border-white/10">
                        <label class="label-premium text-accent-400">Garant 2</label>
                        <input type="text" id="g2Name" placeholder="Nom Prénom" class="input-premium mb-3">
                        <input type="text" id="g2Addr" placeholder="Adresse" class="input-premium mb-3">
                        <div class="grid grid-cols-3 gap-3">
                            <input type="tel" id="g2CP" placeholder="CP" class="input-premium col-span-1">
                            <input type="text" id="g2City" placeholder="Ville" class="input-premium col-span-2">
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-house-line"></i> 4. Le Logement</div>
            <div class="space-y-4">
                <div>
                    <label class="label-premium">Adresse du bien</label>
                    <input type="text" id="propAddr" placeholder="N° et nom de rue" class="input-premium mb-3">
                    <div class="grid grid-cols-3 gap-3">
                        <input type="tel" id="propCP" placeholder="CP" class="input-premium col-span-1">
                        <input type="text" id="propCity" placeholder="Ville" class="input-premium col-span-2">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-premium">Type</label>
                        <select id="propType" class="input-premium">
                            <option>Appartement</option>
                            <option>Maison</option>
                            <option>Studio</option>
                            <option>Chambre</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-premium">Nb Pièces</label>
                        <input type="number" id="propRooms" placeholder="Ex: 2" class="input-premium">
                    </div>
                    <div>
                        <label class="label-premium">Surface (m²)</label>
                        <input type="number" id="propSurf" placeholder="Ex: 45" class="input-premium">
                    </div>
                    <div>
                        <label class="label-premium">Construction</label>
                        <select id="propEra" class="input-premium">
                            <option value="Inconnue">Inconnue</option>
                            <option value="Avant 1948">Avant 1948</option>
                            <option value="1949-1974">1949-1974</option>
                            <option value="1975-1989">1975-1989</option>
                            <option value="1990-2005">1990-2005</option>
                            <option value="Après 2005">Après 2005</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="label-premium">Chauffage</label>
                        <select id="heatType" class="input-premium">
                            <option>Individuel Électrique</option>
                            <option>Individuel Gaz</option>
                            <option>Collectif</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-premium">Eau Chaude</label>
                        <select id="waterType" class="input-premium">
                            <option>Individuelle Élec.</option>
                            <option>Individuelle Gaz</option>
                            <option>Collective</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="label-premium text-accent-400">Nb de jeux de clés remis</label>
                    <input type="number" id="propKeys" value="2" class="input-premium">
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-clock-counter-clockwise"></i> 5. Historique & Légal</div>
            <div class="space-y-4">
                <div>
                    <label class="label-premium">Montant derniers travaux (si applicable)</label>
                    <input type="text" id="histWorks" value="Néant" class="input-premium">
                </div>

                <button class="toggle-btn group" onclick="toggle('zoneTendueForm', this)">
                    <span class="flex items-center gap-2"><i class="ph-bold ph-chart-line-up text-accent-400"></i> Zone Tendue / Encadrement</span>
                    <i class="ph-bold ph-caret-down group-hover:text-accent-400 transition-colors"></i>
                </button>
                <div id="zoneTendueForm" class="hidden-section bg-white/5 rounded-xl p-4 border border-white/5">
                    <p class="text-xs text-slate-400 mb-3 italic">À remplir uniquement si le logement est situé en zone tendue.</p>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="label-premium">Dernier Loyer</label>
                            <input type="text" id="histLastRent" placeholder="€" class="input-premium">
                        </div>
                        <div>
                            <label class="label-premium">Date Révision</label>
                            <input type="text" id="histLastDate" placeholder="JJ/MM/AAAA" class="input-premium">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="label-premium">Réf (€/m²)</label>
                            <input type="text" id="refRent" class="input-premium">
                        </div>
                        <div>
                            <label class="label-premium">Majoré (€/m²)</label>
                            <input type="text" id="maxRent" class="input-premium">
                        </div>
                    </div>
                    <label class="label-premium">Complément de loyer</label>
                    <input type="text" id="supRent" placeholder="Montant et motif" class="input-premium">
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-currency-eur"></i> 6. Loyer & Conditions</div>
            <div class="glass-card p-4 border-accent-400/20 bg-accent-400/5 mb-6">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="label-premium text-white">Loyer HC (€)</label>
                        <input type="number" id="finRent" onchange="calcDeposit()" class="input-premium text-lg font-bold text-accent-400 border-accent-400/30">
                    </div>
                    <div>
                        <label class="label-premium text-white">Charges (€)</label>
                        <input type="number" id="finCharges" class="input-premium text-lg font-bold">
                    </div>
                </div>
                <div>
                    <label class="label-premium">Dépôt de Garantie (2 mois HC)</label>
                    <input type="number" id="finDeposit" class="input-premium">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="label-premium">Date Prise d'effet</label>
                    <input type="date" id="dateStart" class="input-premium">
                </div>
                <div>
                    <label class="label-premium">Type de Bail</label>
                    <select id="durType" class="input-premium">
                        <option value="1 an (Reconductible)">1 An (Résidence Princ.)</option>
                        <option value="9 mois (Étudiant)">9 Mois (Étudiant)</option>
                    </select>
                </div>
            </div>
            <div>
                 <label class="label-premium">Honoraires Agence (Optionnel)</label>
                 <input type="text" id="agencyFees" value="0.00 €" class="input-premium">
            </div>

            <div class="section-title"><i class="ph-duotone ph-files"></i> 7. Annexes remises</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <label class="chk-label"><input type="checkbox" id="chk_edl" checked> <span class="text-sm">État des lieux</span></label>
                <label class="chk-label"><input type="checkbox" id="chk_inv" checked> <span class="text-sm">Inventaire Mobilier</span></label>
                <label class="chk-label"><input type="checkbox" id="chk_dpe" checked> <span class="text-sm">Diagnostic (DPE)</span></label>
                <label class="chk-label"><input type="checkbox" id="chk_erp" checked> <span class="text-sm">État Risques (ERP)</span></label>
                <label class="chk-label"><input type="checkbox" id="chk_reg" checked> <span class="text-sm">Règlement Copro</span></label>
                <label class="chk-label"><input type="checkbox" id="chk_not" checked> <span class="text-sm">Notice Info</span></label>
            </div>

            <div class="section-title"><i class="ph-duotone ph-pen-nib"></i> 8. Signatures Électroniques</div>
            <p class="text-xs text-slate-400 mb-4">Signez dans les cadres blancs ci-dessous.</p>
            
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between items-end mb-1">
                        <label class="label-premium">Propriétaire</label>
                        <button onclick="clearPad('cvLandlord')" class="text-xs text-red-400 hover:text-red-300">Effacer</button>
                    </div>
                    <div class="sig-wrapper">
                        <canvas id="cvLandlord" class="sig-canvas"></canvas>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-1">
                        <label class="label-premium">Locataire 1</label>
                        <button onclick="clearPad('cvT1')" class="text-xs text-red-400 hover:text-red-300">Effacer</button>
                    </div>
                    <div class="sig-wrapper">
                        <canvas id="cvT1" class="sig-canvas"></canvas>
                    </div>
                </div>

                <div id="pad-secT2" class="hidden-section">
                    <div class="flex justify-between items-end mb-1">
                        <label class="label-premium">Locataire 2</label>
                        <button onclick="clearPad('cvT2')" class="text-xs text-red-400 hover:text-red-300">Effacer</button>
                    </div>
                    <div class="sig-wrapper"><canvas id="cvT2" class="sig-canvas"></canvas></div>
                </div>
                <div id="pad-secG1" class="hidden-section">
                    <div class="flex justify-between items-end mb-1">
                        <label class="label-premium">Garant 1</label>
                        <button onclick="clearPad('cvG1')" class="text-xs text-red-400 hover:text-red-300">Effacer</button>
                    </div>
                    <div class="sig-wrapper"><canvas id="cvG1" class="sig-canvas"></canvas></div>
                </div>
                <div id="pad-secG2" class="hidden-section">
                    <div class="flex justify-between items-end mb-1">
                        <label class="label-premium">Garant 2</label>
                        <button onclick="clearPad('cvG2')" class="text-xs text-red-400 hover:text-red-300">Effacer</button>
                    </div>
                    <div class="sig-wrapper"><canvas id="cvG2" class="sig-canvas"></canvas></div>
                </div>
            </div>

            <div class="sticky-action-bar">
                <button class="btn-main w-full py-4 rounded-xl bg-gradient-to-r from-accent-500 to-blue-600 text-white font-bold text-lg shadow-lg hover:shadow-accent-500/20 hover:scale-[1.01] transition-all flex items-center justify-center gap-3" onclick="generatePDF()">
                    <span>Télécharger le Bail PDF</span>
                    <i class="ph-bold ph-download-simple"></i>
                </button>
            </div>
            
        </div>

        <div class="preview-container flex justify-center sticky top-24">
            <div class="relative group">
                 <div class="absolute inset-0 bg-white transform rotate-1 rounded shadow-xl -z-10"></div>
                 <div class="absolute inset-0 bg-white transform -rotate-1 rounded shadow-xl -z-20"></div>
                 
                 <div id="pdf-content">
                    <div class="pdf-header">
                        <div class="pdf-title">CONTRAT DE LOCATION MEUBLÉE</div>
                        <div class="pdf-subtitle">Soumis au titre Ier bis de la loi n° 89-462 du 6 juillet 1989 et modifié par la loi ALUR</div>
                    </div>
        
                    <div class="pdf-section-title">I. DÉSIGNATION DES PARTIES</div>
                    <div class="avoid-break">
                        <div class="pdf-row"><span class="pdf-lbl">LE BAILLEUR :</span> <span class="pdf-val blue" id="oLandlord"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Domicilié :</span> <span class="pdf-val" id="oLandlordAddr"></span></div>
                    </div>
                    <br>
                    <div class="avoid-break">
                        <div class="pdf-row"><span class="pdf-lbl">LE(S) LOCATAIRE(S) :</span> <span class="pdf-val blue" id="oTenant"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Détails :</span> <span class="pdf-val" id="oTenantDetails"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Adresse actuelle :</span> <span class="pdf-val" id="oTenantAddr"></span></div>
                    </div>
                    
                    <div id="pdf-guarantor-block" style="display:none;" class="avoid-break">
                        <br>
                        <div class="pdf-row"><span class="pdf-lbl">LA CAUTION :</span> <span class="pdf-val blue" id="oGuarantor"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Adresse(s) :</span> <span class="pdf-val" id="oGuarantorAddr"></span></div>
                    </div>
        
                    <div class="pdf-section-title">II. OBJET DU CONTRAT ET CONSISTANCE</div>
                    <div class="avoid-break">
                        <div class="pdf-row"><span class="pdf-lbl">Le Logement :</span> <span class="pdf-val"><span id="oPropType"></span> meublé de <span id="oPropSurf"></span> m², comprenant <span id="oPropRooms"></span> pièce(s) principale(s).</span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Adresse :</span> <span class="pdf-val"><span id="oPropAddr"></span>, <span id="oPropCity"></span>.</span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Période Construction :</span> <span class="pdf-val" id="oPropEra"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Chauffage :</span> <span class="pdf-val" id="oHeat"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Eau Chaude :</span> <span class="pdf-val" id="oWater"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Moyens d'accès :</span> <span class="pdf-val"><span id="oPropKeys"></span> jeux de clés remis ce jour.</span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Travaux récents :</span> <span class="pdf-val" id="oHistWorks"></span></div>
                    </div>
        
                    <div class="pdf-section-title">III. DATE DE PRISE D'EFFET ET DURÉE</div>
                    <div class="avoid-break">
                        <div class="pdf-row"><span class="pdf-lbl">Date d'effet :</span> <span class="pdf-val blue" id="oDateStart"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Type de bail :</span> <span class="pdf-val" id="oDurType"></span></div>
                        <div class="clause-text" style="margin-top:5px;">
                            <strong>A. Bail d'un an (Résidence principale) :</strong> Reconduction tacite par période d'un an, faute de congé donné par l'une des parties.
                            <br><strong>B. Bail étudiant (9 mois) :</strong> Le bail prend fin automatiquement à son terme sans reconduction.
                            <br><strong>Congé :</strong> Le locataire peut résilier à tout moment (préavis 1 mois). Le bailleur peut résilier à l'échéance avec motif légitime et sérieux (préavis 3 mois).
                        </div>
                    </div>
        
                    <div class="pdf-section-title">IV. CONDITIONS FINANCIÈRES</div>
                    <div class="avoid-break">
                        <table class="pdf-table">
                            <tr>
                                <td>Loyer Mensuel Hors Charges</td>
                                <td style="text-align:right; font-weight:bold;"><span id="oRent"></span> €</td>
                            </tr>
                            <tr>
                                <td>Charges (Forfait mensuel)</td>
                                <td style="text-align:right; font-weight:bold;"><span id="oCharges"></span> €</td>
                            </tr>
                            <tr>
                                <td class="bg-gray">TOTAL MENSUEL À PAYER</td>
                                <td class="bg-gray" style="text-align:right; color:#1d4ed8;"><span id="oTotal"></span> €</td>
                            </tr>
                            <tr>
                                <td>Dépôt de Garantie (Versé ce jour)</td>
                                <td style="text-align:right;"><span id="oDeposit"></span> €</td>
                            </tr>
                        </table>
                        <div class="clause-text">Le forfait de charges couvre les charges locatives récupérables définies par décret. Il ne donne pas lieu à régularisation annuelle (sauf mention contraire explicite).</div>
                    </div>
        
                    <div id="zoneTendueBlock" style="border:1px solid #000; padding:5px; margin-top:5px; display:none;" class="avoid-break">
                        <div style="font-weight:bold; font-size:9pt; text-decoration:underline;">Informations Zone Tendue / Encadrement :</div>
                        <div class="pdf-row"><span class="pdf-lbl">Dernier loyer appliqué :</span> <span class="pdf-val" id="oLastRent"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Loyer de référence :</span> <span class="pdf-val" id="oRefRent"></span></div>
                        <div class="pdf-row"><span class="pdf-lbl">Complément de loyer :</span> <span class="pdf-val" id="oSupRent"></span></div>
                    </div>
        
                    <div class="pdf-section-title">V. CLAUSES LÉGALES ET OBLIGATIONS</div>
                    
                    <div class="clause-block avoid-break">
                        <span class="clause-title">1. Paiement et Révision du Loyer</span>
                        <div class="clause-text">
                            Le loyer est payable d'avance le 1er de chaque mois. Il sera révisé automatiquement chaque année à la date anniversaire du contrat, en fonction de la variation de l'Indice de Référence des Loyers (IRL) publié par l'INSEE. L'indice de référence est le dernier connu à la date de signature.
                        </div>
                    </div>
        
                    <div class="clause-block avoid-break">
                        <span class="clause-title">2. Obligations du Locataire</span>
                        <div class="clause-text">
                            Le locataire est tenu de : 
                            a) Payer le loyer et les charges au terme convenu. 
                            b) User paisiblement des lieux suivant la destination prévue au contrat. 
                            c) Répondre des dégradations qui surviennent pendant la durée du contrat (hors vétusté). 
                            d) S'assurer contre les risques locatifs (incendie, dégât des eaux) et en justifier lors de la remise des clés et chaque année. 
                            e) Laisser exécuter les travaux d'amélioration des parties communes ou privatives.
                        </div>
                    </div>
        
                    <div class="clause-block avoid-break">
                        <span class="clause-title">3. Clause de Solidarité (Colocation)</span>
                        <div class="clause-text">
                            En cas de colocation, les preneurs sont tenus solidairement et indivisiblement à l'égard du bailleur du paiement des loyers, charges et accessoires. La solidarité d'un colocataire et de sa caution prend fin à la date d'effet du congé régulièrement délivré et lorsqu'un nouveau locataire figure au bail. À défaut de remplaçant, la solidarité s'éteint six mois après la fin du congé.
                        </div>
                    </div>
        
                    <div class="important-box avoid-break">
                        <span class="clause-title" style="color:#b91c1c;">4. CLAUSE RÉSOLUTOIRE DE PLEIN DROIT</span>
                        <div class="clause-text" style="color:#b91c1c;">
                            À défaut de paiement de tout ou partie du loyer ou des charges aux termes convenus, ou en cas de non-versement du dépôt de garantie, <strong>le présent bail sera résilié de plein droit deux mois après un commandement de payer demeuré infructueux</strong>.
                            En cas de défaut d'assurance locative, le bail sera résilié un mois après un commandement resté infructueux.
                            En cas de troubles de voisinage constatés par une décision de justice, la résiliation est acquise.
                        </div>
                    </div>
        
                    <div class="pdf-section-title avoid-break">VI. ANNEXES</div>
                    <div class="clause-text avoid-break">Le locataire reconnaît avoir reçu ce jour, joints au contrat :</div>
                    <ul style="margin:5px 0; padding-left:20px; font-size:9.5pt;" id="oAnnexList" class="avoid-break">
                    </ul>
        
                    <div class="signatures-container avoid-break">
                        <div style="text-align:center; font-weight:bold; background:#e5e7eb; padding:5px; margin-bottom:10px;">VII. SIGNATURES</div>
                        <div style="text-align:center; font-size:9pt; margin-bottom:10px;">
                            Fait à <span id="oSignCity"></span>, le <span id="oSignDate"></span>.<br>
                            En autant d'originaux que de parties contractantes.
                        </div>
        
                        <div class="sig-grid" id="sigGrid">
                        </div>
                        <div style="text-align:center; font-size:7pt; color:#666; margin-top:10px;">
                            Document généré électroniquement valant preuve de l'accord des parties (Art. 1367 Code Civil).
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- LOGIC ---
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ""; }
        const setTxt = (id, val) => { 
            const el = document.getElementById(id); 
            if(el) el.textContent = val || "________________"; 
        };

        // Calc Deposit
        function calcDeposit() {
            const r = parseFloat(getVal('finRent')) || 0;
            document.getElementById('finDeposit').value = r * 2;
        }

        // Toggle Sections (Logic retained, Class adapted)
        function toggle(id, btn) {
            const el = document.getElementById(id);
            const pad = document.getElementById('pad-'+id);
            
            const isHidden = el.style.display !== 'block';
            
            el.style.display = isHidden ? 'block' : 'none';
            btn.classList.toggle('active', isHidden);
            
            // Icon handling
            const icon = btn.querySelector('.ph-caret-down');
            if(icon) {
                icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0)';
            }

            // Gestion des pads signatures liés
            if(pad) {
                pad.style.display = isHidden ? 'block' : 'none';
                if(isHidden) {
                    const canvasId = pad.querySelector('canvas').id;
                    initPad(canvasId);
                }
            }
        }

        // --- SIGNATURE CANVAS (Improved for Touch/Mobile) ---
        const pads = {};
        
        function initPad(cid) {
            const c = document.getElementById(cid);
            if(!c) return;
            
            // Si déjà initialisé, on check juste la taille
            if(pads[cid]) {
                resizeCanvas(c);
                return;
            }

            const ctx = c.getContext('2d');
            
            function resizeCanvas(canvas) {
                const rect = canvas.parentElement.getBoundingClientRect();
                if (rect.width > 0 && canvas.width !== rect.width) {
                    // Sauvegarde image
                    const img = canvas.toDataURL();
                    canvas.width = rect.width;
                    canvas.height = 100; // Fixed height
                    ctx.lineWidth = 2; 
                    ctx.lineCap = 'round'; 
                    ctx.strokeStyle = '#000';
                    
                    // Restore logic could be added here if needed, 
                    // but usually clearing on resize is safer for crisp drawing
                }
            }

            resizeCanvas(c);
            
            let drawing = false;
            const getPos = (e) => {
                const r = c.getBoundingClientRect();
                // Support Touch & Mouse
                const x = e.touches && e.touches.length > 0 ? e.touches[0].clientX : e.clientX;
                const y = e.touches && e.touches.length > 0 ? e.touches[0].clientY : e.clientY;
                return { x: x - r.left, y: y - r.top };
            };
            
            const start = (e) => { 
                drawing = true; 
                ctx.beginPath(); 
                const p = getPos(e); 
                ctx.moveTo(p.x, p.y); 
                // Prevent scrolling on touch
                if(e.type === 'touchstart') e.preventDefault(); 
            };
            
            const draw = (e) => { 
                if(!drawing) return; 
                const p = getPos(e); 
                ctx.lineTo(p.x, p.y); 
                ctx.stroke(); 
                if(e.type === 'touchmove') e.preventDefault(); 
            };
            
            const end = () => drawing = false;

            c.addEventListener('mousedown', start);
            c.addEventListener('mousemove', draw);
            c.addEventListener('mouseup', end);
            c.addEventListener('mouseleave', end);
            
            c.addEventListener('touchstart', start, {passive: false});
            c.addEventListener('touchmove', draw, {passive: false});
            c.addEventListener('touchend', end);
            
            pads[cid] = c;
        }
        
        function clearPad(cid) { 
            const c = document.getElementById(cid);
            if(c) c.getContext('2d').clearRect(0,0,c.width,c.height); 
        }

        // --- INIT ---
        window.onload = () => { 
            // Init always visible pads
            ['cvLandlord','cvT1'].forEach(initPad);
            
            // Re-init on resize (orientation change)
            window.addEventListener('resize', () => {
                Object.keys(pads).forEach(k => initPad(k));
            });
        };

        // --- PDF GENERATION ---
        function generatePDF() {
            // 1. DATA MAPPING
            setTxt('oLandlord', getVal('landlordName'));
            setTxt('oLandlordAddr', getVal('landlordAddress'));

            // Locataires
            let tDetails = "Né(e) le " + (getVal('t1Dob') ? new Date(getVal('t1Dob')).toLocaleDateString('fr-FR') : "__/__/____") + " à " + getVal('t1Pob');
            let tName = getVal('t1Name');
            let tAddr = getVal('t1Addr') + (getVal('t1CP') ? ", " + getVal('t1CP') : "") + (getVal('t1City') ? " " + getVal('t1City') : "");

            if(document.getElementById('secT2').style.display === 'block') {
                tName += " et " + getVal('t2Name');
                tDetails += " ; " + getVal('t2Name') + " (" + (getVal('t2Dob') ? new Date(getVal('t2Dob')).toLocaleDateString('fr-FR') : "") + ")";
                let t2FullAddr = getVal('t2Addr') + (getVal('t2CP') ? ", " + getVal('t2CP') : "") + (getVal('t2City') ? " " + getVal('t2City') : "");
                tAddr += " / " + t2FullAddr;
            }
            setTxt('oTenant', tName);
            setTxt('oTenantDetails', tDetails);
            setTxt('oTenantAddr', tAddr);

            // Garants
            const hasG1 = document.getElementById('secG1').style.display === 'block';
            const hasG2 = document.getElementById('secG2') && document.getElementById('secG2').style.display === 'block';
            let gName = "", gAddr = "";
            
            if(hasG1) { 
                gName += getVal('g1Name'); 
                gAddr += getVal('g1Addr') + (getVal('g1CP') ? ", " + getVal('g1CP') : "") + (getVal('g1City') ? " " + getVal('g1City') : "");
            }
            if(hasG2) { 
                gName += " et " + getVal('g2Name'); 
                let g2FullAddr = getVal('g2Addr') + (getVal('g2CP') ? ", " + getVal('g2CP') : "") + (getVal('g2City') ? " " + getVal('g2City') : "");
                gAddr += " et " + g2FullAddr; 
            }
            
            const gb = document.getElementById('pdf-guarantor-block');
            if(gName) { gb.style.display = 'block'; setTxt('oGuarantor', gName); setTxt('oGuarantorAddr', gAddr); }
            else { gb.style.display = 'none'; }

            // Bien
            setTxt('oPropAddr', getVal('propAddr'));
            let propLoc = (getVal('propCP') ? getVal('propCP') + " " : "") + getVal('propCity');
            setTxt('oPropCity', propLoc);
            
            setTxt('oPropType', getVal('propType'));
            setTxt('oPropSurf', getVal('propSurf'));
            setTxt('oPropRooms', getVal('propRooms'));
            setTxt('oPropEra', getVal('propEra'));
            setTxt('oHeat', getVal('heatType'));
            setTxt('oWater', getVal('waterType'));
            setTxt('oPropKeys', getVal('propKeys'));
            setTxt('oHistWorks', getVal('histWorks'));

            // Finances
            const r = parseFloat(getVal('finRent')||0);
            const c = parseFloat(getVal('finCharges')||0);
            setTxt('oRent', r.toFixed(2));
            setTxt('oCharges', c.toFixed(2));
            setTxt('oTotal', (r+c).toFixed(2));
            setTxt('oDeposit', getVal('finDeposit'));

            // Zone Tendue
            const lastRent = getVal('histLastRent');
            const refRent = getVal('refRent');
            const maxRent = getVal('maxRent');
            const ztBlock = document.getElementById('zoneTendueBlock');
            const ztFormVisible = document.getElementById('zoneTendueForm').style.display === 'block';

            if(ztFormVisible && (lastRent || refRent)) {
                ztBlock.style.display = 'block';
                setTxt('oLastRent', lastRent ? lastRent + " (Date: " + getVal('histLastDate') + ")" : "Non renseigné");
                setTxt('oRefRent', (refRent) ? refRent + "€/m² (Ref) / " + maxRent + "€/m² (Majoré)" : "Non renseigné");
                setTxt('oSupRent', getVal('supRent') || "Aucun");
            } else {
                ztBlock.style.display = 'none';
            }

            // Dates
            const ds = getVal('dateStart');
            setTxt('oDateStart', ds ? new Date(ds).toLocaleDateString('fr-FR') : "__/__/____");
            setTxt('oDurType', getVal('durType'));
            setTxt('oSignCity', getVal('propCity') || "Evian");
            setTxt('oSignDate', new Date().toLocaleDateString('fr-FR'));

            // Annexes
            const ul = document.getElementById('oAnnexList');
            ul.innerHTML = "";
            ['edl','inv','dpe','erp','reg','not'].forEach(k => {
                const chk = document.getElementById('chk_'+k);
                if(chk && chk.checked) {
                    const li = document.createElement('li');
                    li.textContent = chk.parentElement.querySelector('span').textContent.trim();
                    ul.appendChild(li);
                }
            });

            // Signatures Images Mapping
            const grid = document.getElementById('sigGrid');
            grid.innerHTML = "";
            const addSig = (role, name, cid) => {
                const div = document.createElement('div');
                div.className = 'sig-box';
                const cvs = document.getElementById(cid);
                // Important: get data directly from canvas
                const dataUrl = cvs ? cvs.toDataURL() : "";
                div.innerHTML = `<div style="text-align:center;font-size:7pt;background:#eee;">${role}</div><img src="${dataUrl}" class="sig-img"><div class="sig-name">${name}</div>`;
                grid.appendChild(div);
            };

            addSig("LE BAILLEUR", getVal('landlordName'), 'cvLandlord');
            addSig("LE LOCATAIRE", getVal('t1Name'), 'cvT1');
            if(document.getElementById('secT2').style.display === 'block') addSig("LOCATAIRE 2", getVal('t2Name'), 'cvT2');
            if(hasG1) addSig("LA CAUTION", getVal('g1Name'), 'cvG1');
            if(hasG2) addSig("LA CAUTION 2", getVal('g2Name'), 'cvG2');

            // 2. EXPORT PDF
            const element = document.getElementById('pdf-content');
            const btn = document.querySelector('.btn-main');
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = `<span>Génération en cours...</span> <i class="ph-bold ph-spinner animate-spin"></i>`;
            
            // Temporary reveal for mobile generation if hidden
            const previewContainer = document.querySelector('.preview-container');
            const wasHidden = window.getComputedStyle(previewContainer).opacity === '0';
            
            if(wasHidden) {
                previewContainer.style.opacity = '1'; 
                previewContainer.style.position = 'absolute';
                previewContainer.style.left = '-9999px'; // Move off-screen instead of display:none
                previewContainer.style.height = 'auto';
                previewContainer.style.overflow = 'visible';
            }

            const opt = {
                /* CORRECTION : Marges gérées ici (Haut, Droite, Bas, Gauche) */
                /* 15mm vertical, 20mm horizontal pour respecter le standard A4 et éviter la coupure */
                margin:       [15, 20, 15, 20], 
                
                filename:     `Bail_${getVal('t1Name').replace(/\s/g,'_') || 'Nouveau'}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['css', 'legacy'] }
            };

            // Delay to ensure rendering
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => {
                    btn.innerHTML = originalBtnContent;
                    if(wasHidden) {
                        previewContainer.style = ""; // Reset style
                    }
                });
            }, 500);
        }
    </script>
</body>
</html>
