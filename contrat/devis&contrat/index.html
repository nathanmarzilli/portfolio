<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Générateur Devis & Factures | Nathan Marzilli</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        dark: { 950: '#020617', 900: '#0B1120', 800: '#1E293B' },
                        accent: { 400: '#2DD4BF', 500: '#14B8A6' },
                        gold: { 400: '#FBBF24' }
                    },
                    animation: { 'blob': 'blob 7s infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #E2E8F0; }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border-radius: 1.5rem;
        }

        .input-premium {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 0.5rem;
            padding: 0.6rem 0.8rem;
            width: 100%;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        .input-premium:focus {
            border-color: #2DD4BF;
            outline: none;
            background: rgba(15, 23, 42, 0.9);
        }
        
        .label-premium {
            display: block;
            font-size: 0.7rem;
            font-weight: 600;
            color: #94A3B8;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .section-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-title i { color: #2DD4BF; }

        /* Switch Mode */
        .mode-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        .mode-btn.active {
            background: #2DD4BF;
            color: #020617;
            box-shadow: 0 0 15px rgba(45,212,191,0.3);
        }
        .mode-btn.inactive {
            background: rgba(255,255,255,0.05);
            color: #94a3b8;
            border-color: rgba(255,255,255,0.1);
        }

        /* PDF Engine Styles */
        #pdf-content {
            background: white;
            color: #1e293b;
            font-family: 'Inter', sans-serif; /* Plus moderne qu'une quittance */
            font-size: 10pt;
            width: 210mm;
            min-height: 297mm;
            padding: 0;
            margin: 0 auto;
            position: relative;
        }
        .pdf-page { padding: 15mm 15mm; height: 100%; position: relative; }
        
        /* Table Styles within PDF */
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        .doc-table th { text-align: left; padding: 10px; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 8pt; text-transform: uppercase; font-weight: 600; }
        .doc-table td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        .doc-table td.desc { width: 55%; }
        .doc-table td.qty { width: 10%; text-align: center; }
        .doc-table td.price { width: 15%; text-align: right; }
        .doc-table td.total { width: 20%; text-align: right; font-weight: 600; }

        /* Signature Canvas */
        .sig-wrapper { background: white; border-radius: 0.5rem; border: 2px dashed #475569; position: relative; overflow: hidden; }
        canvas.sig-canvas { width: 100%; height: 100px; cursor: crosshair; display: block; touch-action: none; }

        @media (max-width: 1024px) {
            .app-grid { grid-template-columns: 1fr; }
            .preview-container { display: none; }
            .preview-container.show-for-print { display: block; position: absolute; top: 0; left: 0; z-index: -100; opacity: 0; pointer-events: none; }
        }
    </style>
</head>
<body class="selection:bg-accent-400/30 selection:text-white pb-24 lg:pb-10">

    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none -z-10">
        <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[100px] mix-blend-screen animate-blob"></div>
        <div class="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-accent-400/10 rounded-full blur-[100px] mix-blend-screen animate-blob animation-delay-2000"></div>
    </div>

    <nav class="w-full border-b border-white/5 bg-dark-950/50 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="index.html" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent-400 to-blue-600 flex items-center justify-center text-dark-950 font-bold">
                        <i class="ph-bold ph-file-text"></i>
                    </div>
                    <span class="font-display font-bold text-lg tracking-wide text-white">Nathan<span class="text-accent-400">Docs</span></span>
                </a>
            </div>
            <a href="index.html" class="text-xs font-medium text-slate-400 hover:text-white transition-colors flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i> Retour au site
            </a>
        </div>
    </nav>

    <main class="grid lg:grid-cols-[450px_1fr] gap-8 p-4 lg:p-8 max-w-[1600px] mx-auto items-start">
        
        <div class="glass-card form-panel p-6">
            
            <div class="flex p-1 bg-dark-900 rounded-lg mb-6 border border-white/10">
                <button onclick="setMode('quote')" id="btn-quote" class="mode-btn active flex-1">Devis</button>
                <button onclick="setMode('invoice')" id="btn-invoice" class="mode-btn inactive flex-1">Facture</button>
            </div>

            <div class="section-title mt-0"><i class="ph-duotone ph-identification-card"></i> Infos Client</div>
            <div class="space-y-3">
                <div>
                    <label class="label-premium">Client / Société</label>
                    <input type="text" id="clientName" placeholder="ex: SAS MABOUL" class="input-premium" oninput="updatePreview()">
                </div>
                <div>
                    <label class="label-premium">Adresse</label>
                    <textarea id="clientAddr" rows="2" placeholder="Adresse complète" class="input-premium resize-none" oninput="updatePreview()"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="label-premium">N° Doc</label>
                        <input type="text" id="docNumber" value="DEV-2024-001" class="input-premium" oninput="updatePreview()">
                    </div>
                    <div>
                        <label class="label-premium">Date</label>
                        <input type="date" id="docDate" class="input-premium" onchange="updatePreview()">
                    </div>
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-list-plus"></i> Prestations</div>
            
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
                <button onclick="addItem('Pack Essentiel', 900)" class="text-[10px] bg-white/5 border border-white/10 px-2 py-1 rounded text-slate-300 hover:bg-accent-400 hover:text-dark-950 transition-colors whitespace-nowrap">+ Essentiel</button>
                <button onclick="addItem('Pack Vitrine Artisan', 1700)" class="text-[10px] bg-white/5 border border-white/10 px-2 py-1 rounded text-slate-300 hover:bg-accent-400 hover:text-dark-950 transition-colors whitespace-nowrap">+ Vitrine</button>
                <button onclick="addItem('Pack Premium', 2500)" class="text-[10px] bg-white/5 border border-white/10 px-2 py-1 rounded text-slate-300 hover:bg-accent-400 hover:text-dark-950 transition-colors whitespace-nowrap">+ Premium</button>
                <button onclick="addItem('Acompte 30%', -1)" class="text-[10px] bg-white/5 border border-white/10 px-2 py-1 rounded text-gold-400 border-gold-400/30 hover:bg-gold-400 hover:text-dark-950 transition-colors whitespace-nowrap">% Acompte</button>
            </div>

            <div id="items-container" class="space-y-3 mb-4">
                </div>
            
            <button onclick="addItem()" class="w-full py-2 rounded border border-dashed border-white/20 text-slate-400 text-xs hover:border-accent-400 hover:text-accent-400 transition-colors">
                + Ajouter une ligne vide
            </button>

            <div class="mt-4 pt-4 border-t border-white/10">
                <div class="flex justify-between items-center mb-2">
                    <label class="label-premium mb-0">Appliquer TVA (20%)</label>
                    <input type="checkbox" id="tvaToggle" class="accent-accent-400 w-4 h-4" onchange="calcTotal()">
                </div>
                <div class="flex justify-between items-center text-xl font-bold text-accent-400">
                    <span>Total à payer</span>
                    <span id="formTotal">0.00 €</span>
                </div>
            </div>

            <div class="section-title"><i class="ph-duotone ph-pen-nib"></i> Validation</div>
            <div id="sign-section">
                <div class="mb-2 flex justify-between items-end">
                    <label class="label-premium">Signature Client (Bon pour accord)</label>
                    <button onclick="clearPad()" class="text-xs text-red-400 hover:text-red-300 transition-colors">Effacer</button>
                </div>
                <div class="sig-wrapper">
                    <canvas id="sigCanvas"></canvas>
                </div>
            </div>
            
            <div class="sticky bottom-0 bg-dark-950/80 backdrop-blur pt-4 pb-2 mt-6 border-t border-white/10">
                <button class="w-full py-4 rounded-xl bg-gradient-to-r from-accent-500 to-blue-600 text-white font-bold text-lg shadow-lg hover:shadow-accent-500/20 hover:scale-[1.01] transition-all flex items-center justify-center gap-3" onclick="generatePDF()">
                    <span>Télécharger PDF</span>
                    <i class="ph-bold ph-download-simple"></i>
                </button>
            </div>
        </div>

        <div class="preview-container flex justify-center sticky top-24">
            <div class="relative shadow-2xl">
                <div id="pdf-content">
                    <div class="pdf-page">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
                            <div>
                                <h1 style="font-size: 24pt; font-weight: 800; color: #1e293b; letter-spacing: -1px; margin: 0;">
                                    Nathan <span style="color: #14b8a6;">Marzilli</span>
                                </h1>
                                <p style="font-size: 9pt; color: #64748b; margin-top: 5px; line-height: 1.4;">
                                    Ingénieur & Artisan Web<br>
                                    74500 Évian-les-Bains<br>
                                    SIRET : 123 456 789 00012<br>
                                    nathan.marzilli@gmail.com
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div id="docTitle" style="font-size: 28pt; font-weight: 800; color: #e2e8f0; text-transform: uppercase; letter-spacing: 2px;">DEVIS</div>
                                <div style="margin-top: 10px; font-size: 10pt;">
                                    <strong>N° <span id="pDocNumber"></span></strong><br>
                                    Date : <span id="pDocDate"></span>
                                </div>
                            </div>
                        </div>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 40px; width: 50%; margin-left: auto;">
                            <p style="font-size: 8pt; color: #94a3b8; text-transform: uppercase; font-weight: 700; margin-bottom: 5px;">Destinataire</p>
                            <div style="font-size: 11pt; font-weight: 700; color: #0f172a;" id="pClientName">Nom du Client</div>
                            <div style="font-size: 10pt; color: #334155; white-space: pre-line;" id="pClientAddr">Adresse...</div>
                        </div>

                        <table class="doc-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th style="text-align: center;">Qté</th>
                                    <th style="text-align: right;">Prix Unit.</th>
                                    <th style="text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody id="pTableBody">
                                </tbody>
                        </table>

                        <div style="margin-top: 30px; display: flex; justify-content: flex-end;">
                            <table style="width: 40%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px; text-align: right; color: #64748b;">Total HT</td>
                                    <td style="padding: 8px; text-align: right; font-weight: 600;" id="pTotalHT">0.00 €</td>
                                </tr>
                                <tr id="rowTVA" style="display: none;">
                                    <td style="padding: 8px; text-align: right; color: #64748b;">TVA (20%)</td>
                                    <td style="padding: 8px; text-align: right;" id="pTVA">0.00 €</td>
                                </tr>
                                <tr style="border-top: 2px solid #0f172a;">
                                    <td style="padding: 15px 8px; text-align: right; font-weight: 800; font-size: 14pt;">NET À PAYER</td>
                                    <td style="padding: 15px 8px; text-align: right; font-weight: 800; font-size: 14pt; color: #14b8a6;" id="pTotalNet">0.00 €</td>
                                </tr>
                            </table>
                        </div>

                        <div style="position: absolute; bottom: 15mm; left: 15mm; right: 15mm;">
                            <div style="font-size: 8pt; color: #64748b; margin-bottom: 20px; text-align: justify; line-height: 1.4;" id="legalText">
                                </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px;">
                                <div style="font-size: 8pt; color: #94a3b8;">
                                    Dispensé d'immatriculation au registre du commerce et des sociétés (RCS) et au répertoire des métiers (RM).
                                    <span id="tvaMention">TVA non applicable, art. 293 B du CGI.</span>
                                </div>
                                <div id="pSigBlock" style="border: 1px solid #cbd5e1; height: 80px; width: 200px; padding: 5px;">
                                    <div style="font-size: 7pt; color: #94a3b8; margin-bottom: 2px;">Bon pour accord (Date & Signature)</div>
                                    <img id="pSigImg" style="max-height: 60px; max-width: 100%; display: none;">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA STATE ---
        let currentMode = 'quote'; // 'quote' or 'invoice'
        let items = [
            { desc: "Création Site Web - Pack Vitrine", qty: 1, price: 1700 }
        ];

        // --- INIT ---
        window.onload = function() {
            const d = new Date();
            document.getElementById('docDate').valueAsDate = d;
            
            // Signature logic
            initPad();
            
            // Render initial state
            renderItems();
            setMode('quote');
        };

        // --- MODE SWITCHER ---
        function setMode(mode) {
            currentMode = mode;
            const btnQuote = document.getElementById('btn-quote');
            const btnInvoice = document.getElementById('btn-invoice');
            
            if (mode === 'quote') {
                btnQuote.className = 'mode-btn active flex-1';
                btnInvoice.className = 'mode-btn inactive flex-1';
                document.getElementById('docTitle').innerText = "DEVIS";
                document.getElementById('docTitle').style.color = "#e2e8f0"; // Slate Light
                
                // Texte légal Devis
                document.getElementById('legalText').innerHTML = `
                    <strong>Validité du devis :</strong> 30 jours.<br>
                    <strong>Conditions de règlement :</strong> 30% à la commande, solde à la livraison.<br>
                    La signature du présent devis vaut acceptation des conditions générales de vente. Le transfert de propriété intellectuelle ne sera effectif qu'après paiement intégral de la prestation.
                `;
                document.getElementById('pSigBlock').style.display = 'block';
                document.getElementById('sign-section').style.display = 'block';
                
                // Auto numéro
                if(document.getElementById('docNumber').value.startsWith('FAC')) {
                    document.getElementById('docNumber').value = "DEV-2026-001";
                }

            } else {
                btnInvoice.className = 'mode-btn inactive flex-1';
                btnInvoice.className = 'mode-btn active flex-1';
                document.getElementById('docTitle').innerText = "FACTURE";
                document.getElementById('docTitle').style.color = "#14b8a6"; // Teal
                
                // Texte légal Facture
                document.getElementById('legalText').innerHTML = `
                    <strong>Conditions de paiement :</strong> Réception de facture, sans escompte.<br>
                    <strong>Pénalités de retard :</strong> 3 fois le taux d'intérêt légal. Indemnité forfaitaire pour frais de recouvrement : 40€.<br>
                    <strong>Réserve de propriété :</strong> Les biens/services vendus demeurent la propriété du vendeur jusqu'au complet paiement du prix.
                `;
                // Souvent pas de signature sur une facture transmise par email, mais on peut la laisser si besoin
                // Ici on la cache pour le style "clean"
                document.getElementById('pSigBlock').style.display = 'none';
                document.getElementById('sign-section').style.display = 'none';

                if(document.getElementById('docNumber').value.startsWith('DEV')) {
                    document.getElementById('docNumber').value = "FAC-2026-001";
                }
            }
            updatePreview();
        }

        // --- ITEMS MANAGEMENT ---
        function addItem(name = "", price = 0) {
            if(price === -1) {
                // Logique Acompte : Calculer 30% du total actuel
                let total = items.reduce((acc, item) => acc + (item.qty * item.price), 0);
                price = -(total * 0.30);
                name = "Acompte à la commande (30%)";
            }
            items.push({ desc: name, qty: 1, price: price });
            renderItems();
        }

        function updateItem(index, field, value) {
            items[index][field] = field === 'desc' ? value : parseFloat(value);
            renderItems();
        }

        function removeItem(index) {
            items.splice(index, 1);
            renderItems();
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            const tbody = document.getElementById('pTableBody');
            
            container.innerHTML = '';
            tbody.innerHTML = '';
            
            let totalHT = 0;

            items.forEach((item, index) => {
                const lineTotal = item.qty * item.price;
                totalHT += lineTotal;

                // Form Inputs
                const div = document.createElement('div');
                div.className = "grid grid-cols-[1fr_60px_90px_30px] gap-2 items-center";
                div.innerHTML = `
                    <input type="text" class="input-premium text-xs" value="${item.desc}" oninput="updateItem(${index}, 'desc', this.value)" placeholder="Description">
                    <input type="number" class="input-premium text-xs text-center" value="${item.qty}" oninput="updateItem(${index}, 'qty', this.value)">
                    <input type="number" step="0.01" class="input-premium text-xs text-right" value="${item.price.toFixed(2)}" oninput="updateItem(${index}, 'price', this.value)">
                    <button onclick="removeItem(${index})" class="text-red-400 hover:text-red-200"><i class="ph-bold ph-trash"></i></button>
                `;
                container.appendChild(div);

                // Preview Row
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="desc">${item.desc}</td>
                    <td class="qty">${item.qty}</td>
                    <td class="price">${item.price.toFixed(2)} €</td>
                    <td class="total">${lineTotal.toFixed(2)} €</td>
                `;
                tbody.appendChild(tr);
            });

            // Calc Totals
            const tvaActive = document.getElementById('tvaToggle').checked;
            const tvaAmt = tvaActive ? totalHT * 0.20 : 0;
            const totalNet = totalHT + tvaAmt;

            document.getElementById('formTotal').innerText = totalNet.toFixed(2) + " €";
            
            document.getElementById('pTotalHT').innerText = totalHT.toFixed(2) + " €";
            
            const rowTVA = document.getElementById('rowTVA');
            const tvaMention = document.getElementById('tvaMention');
            
            if (tvaActive) {
                rowTVA.style.display = 'table-row';
                document.getElementById('pTVA').innerText = tvaAmt.toFixed(2) + " €";
                tvaMention.style.display = 'none';
            } else {
                rowTVA.style.display = 'none';
                tvaMention.style.display = 'inline';
            }
            
            document.getElementById('pTotalNet').innerText = totalNet.toFixed(2) + " €";
        }

        // --- GENERIC UPDATE ---
        function updatePreview() {
            // Header Info
            document.getElementById('pClientName').innerText = document.getElementById('clientName').value || "Nom du Client";
            document.getElementById('pClientAddr').innerText = document.getElementById('clientAddr').value || "Adresse...";
            document.getElementById('pDocNumber').innerText = document.getElementById('docNumber').value;
            
            const d = new Date(document.getElementById('docDate').value);
            document.getElementById('pDocDate').innerText = !isNaN(d) ? d.toLocaleDateString('fr-FR') : "...";
        }
        
        function calcTotal() { renderItems(); } // Alias for checkbox trigger

        // --- SIGNATURE PAD (Reused logic) ---
        let canvas, ctx, drawing = false;
        function initPad() {
            canvas = document.getElementById('sigCanvas');
            ctx = canvas.getContext('2d');
            const resize = () => {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = 100;
                ctx.lineWidth = 2; ctx.strokeStyle = '#000';
            };
            window.addEventListener('resize', resize);
            resize(); // Init size

            const getPos = (e) => {
                const r = canvas.getBoundingClientRect();
                return {
                    x: (e.touches ? e.touches[0].clientX : e.clientX) - r.left,
                    y: (e.touches ? e.touches[0].clientY : e.clientY) - r.top
                };
            }
            const start = (e) => { drawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x, p.y); if(e.type==='touchstart') e.preventDefault(); };
            const move = (e) => { if(!drawing) return; const p=getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); if(e.type==='touchmove') e.preventDefault(); };
            const end = () => { 
                drawing=false; 
                const img = document.getElementById('pSigImg');
                img.src = canvas.toDataURL();
                img.style.display = 'block';
            };

            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false}); canvas.addEventListener('touchend', end);
        }
        function clearPad() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('pSigImg').style.display = 'none';
            document.getElementById('pSigImg').src = '';
        }

        // --- PDF GENERATION ---
        function generatePDF() {
            window.scrollTo(0,0);
            const element = document.getElementById('pdf-content');
            
            // Mobile Fix
            const previewContainer = document.querySelector('.preview-container');
            const wasHidden = window.getComputedStyle(previewContainer).display === 'none';
            if(wasHidden) previewContainer.classList.add('show-for-print');

            const name = document.getElementById('clientName').value.replace(/[^a-z0-9]/gi, '_') || "Client";
            const type = currentMode === 'quote' ? 'DEVIS' : 'FACTURE';
            const num = document.getElementById('docNumber').value;

            const opt = {
                margin: 0,
                filename: `${type}_${num}_${name}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                if(wasHidden) previewContainer.classList.remove('show-for-print');
            });
        }
    </script>
</body>
</html>
